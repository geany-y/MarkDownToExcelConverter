# 設計書

## 概要

MarkdownファイルをExcelファイルに変換するプログラムの設計。Markdownの構造とインデントを保持しながら、Excelの方眼紙形式で出力する。プログラムはElectronアプリケーションとして実装し、JavaScript/TypeScriptを使用してMarkdownの解析とExcelファイルの生成を行う。単一の実行ファイルとして配布可能で、他者への配布が容易。

## アーキテクチャ

```
[Markdownファイル] → [Markdown Parser] → [構造化データ] → [Excel Generator] → [Excelファイル]
```

### 主要コンポーネント

1. **CLI Interface**: コマンドライン引数の処理とユーザーインターフェース
2. **Markdown Parser**: Markdownファイルの解析とデータ構造への変換
3. **Excel Generator**: 構造化データからExcelファイルの生成
4. **Configuration Manager**: 変換設定の管理

## コンポーネントとインターフェース

### CLI Interface
- **責任**: コマンドライン引数の解析、ファイルパスの検証、エラーハンドリング
- **入力**: コマンドライン引数（入力ファイルパス、出力ファイルパス）
- **出力**: 処理結果メッセージ、エラーメッセージ

### Markdown Parser
- **責任**: Markdownファイルの読み込み、構文解析、構造化データへの変換
- **入力**: Markdownファイルパス
- **出力**: 構造化されたドキュメントデータ（行ごとの内容とインデントレベル）

### Excel Generator
- **責任**: 構造化データからExcelファイルの生成、セル書式設定
- **入力**: 構造化されたドキュメントデータ
- **出力**: Excelファイル

### Configuration Manager
- **責任**: 変換設定の管理（セルサイズ、インデント幅など）
- **設定項目**: セル幅、行高さ、インデント検出ルール

## データモデル

### DocumentLine
```typescript
interface DocumentLine {
    content: string;              // 行の内容（Markdown記法を除去したプレーンテキスト）
    indentLevel: number;          // インデントレベル（0から開始）
    lineType: string;            // 行の種類（header, paragraph, list_item, code_block, empty）
    formatting: FormatInfo;      // 書式情報
    originalLine: string;        // 元の行内容（デバッグ用）
}

interface FormatInfo {
    isBold: boolean;             // 太字
    isItalic: boolean;           // 斜体
    isStrikethrough: boolean;    // 取り消し線
    isCode: boolean;             // インラインコード
    isQuote: boolean;            // 引用
    isHorizontalRule: boolean;   // 水平線
    headerLevel: number;         // 見出しレベル（0=見出しでない、1-6=見出し）
    hyperlinkUrl: string;        // ハイパーリンクURL
    backgroundColor: string;     // 背景色（16進数）
    fontSize: number;            // フォントサイズ
}
```

### Document
```typescript
interface Document {
    lines: DocumentLine[];       // ドキュメントの全行
    metadata: Record<string, any>; // メタデータ（ファイル名、変換日時など）
}
```

### ExcelConfig
```typescript
interface ExcelConfig {
    cellWidth: number;                    // セル幅（文字数）
    rowHeight: number;                    // 行高さ（ポイント）
    indentColumnOffset: number;           // インデント1レベルあたりの列オフセット
    fontName: string;                     // 通常フォント名
    codeFontName: string;                 // コード用等幅フォント名
    baseFontSize: number;                 // 基本フォントサイズ
    headerFontSizes: Record<number, number>; // 見出しレベル別フォントサイズ
    codeBackgroundColor: string;          // コード背景色
    quoteBackgroundColor: string;         // 引用背景色
    imageBackgroundColor: string;         // 画像背景色
    quoteBorderColor: string;             // 引用左境界線色
    horizontalRuleColor: string;          // 水平線色
}

const defaultExcelConfig: ExcelConfig = {
    cellWidth: 15.0,
    rowHeight: 20.0,
    indentColumnOffset: 1,
    fontName: "Arial",
    codeFontName: "Consolas",
    baseFontSize: 11,
    headerFontSizes: { 1: 18, 2: 16, 3: 14, 4: 12, 5: 11, 6: 10 },
    codeBackgroundColor: "F5F5F5",
    quoteBackgroundColor: "E8F4FD",
    imageBackgroundColor: "FFF2CC",
    quoteBorderColor: "4472C4",
    horizontalRuleColor: "D0D0D0"
};
```

## 正確性プロパティ

*プロパティとは、システムのすべての有効な実行において真であるべき特性や動作のことです。本質的には、システムが何をすべきかについての形式的な記述です。プロパティは、人間が読める仕様と機械で検証可能な正確性保証の橋渡しとなります。*

### プロパティ反映

事前作業の分析を確認した結果、以下の冗長性を特定しました：

- プロパティ1.1と1.3は、どちらもファイル読み込み機能をテストしており、1.3が1.1を包含します
- プロパティ4.1と4.2は、どちらもセル書式設定をテストしており、4.3の方眼紙形式プロパティに統合できます
- プロパティ2.2と2.3は、どちらもインデント配置をテストしており、より包括的な単一プロパティに統合できます

### 正確性プロパティ

**プロパティ1: ファイル読み込みと解析**
*任意の*有効なMarkdownファイルに対して、パーサーはファイルを正常に読み込み、構造化されたドキュメントデータに変換する
**検証対象: 要件 1.1, 1.3**

**プロパティ2: Excelファイル生成**
*任意の*構造化されたドキュメントデータに対して、指定されたパスにExcelファイルが正常に生成される
**検証対象: 要件 1.4**

**プロパティ3: 成功メッセージ表示**
*任意の*正常な変換処理に対して、システムは成功メッセージを表示する
**検証対象: 要件 1.5**

**プロパティ4: インデントレベル検出**
*任意の*インデントを含むMarkdownテキストに対して、パーサーはインデントレベルを正確に検出する
**検証対象: 要件 2.1**

**プロパティ5: インデント構造の列配置**
*任意の*インデント構造を持つドキュメントに対して、各インデントレベルは対応するExcel列に正確に配置される
**検証対象: 要件 2.2, 2.3**

**プロパティ6: スペース・タブインデント認識**
*任意の*スペースまたはタブでインデントされたテキストに対して、システムは両方の形式を正しく認識する
**検証対象: 要件 2.4**

**プロパティ7: 見出し要素変換**
*任意の*Markdown見出し要素に対して、見出しテキストがExcelセルに出力される
**検証対象: 要件 3.1**

**プロパティ8: 段落テキスト変換**
*任意の*Markdown段落テキストに対して、段落内容がExcelセルに出力される
**検証対象: 要件 3.2**

**プロパティ9: リスト要素変換**
*任意の*Markdownリスト要素に対して、リスト項目がExcelセルに出力される
**検証対象: 要件 3.3**

**プロパティ10: 表要素除外**
*任意の*Markdown表要素に対して、システムは表を変換対象から除外する
**検証対象: 要件 3.4**

**プロパティ11: コードブロック変換**
*任意の*Markdownコードブロックに対して、コードブロック内容がExcelセルに出力される
**検証対象: 要件 3.5**

**プロパティ12: 方眼紙形式レイアウト**
*任意の*生成されるExcelファイルに対して、すべてのセルが統一された列幅と行高さを持つ方眼紙形式で配置される
**検証対象: 要件 4.1, 4.2, 4.3**

**プロパティ13: 複数行内容の行分割**
*任意の*複数行にわたる内容に対して、各行が別々のExcel行に配置される
**検証対象: 要件 4.4**

**プロパティ14: 空行保持**
*任意の*空行を含むMarkdownに対して、対応する空行がExcelでも保持される
**検証対象: 要件 4.5**

**プロパティ15: 見出し書式適用**
*任意の*Markdown見出し記法に対して、見出しレベルに応じたExcelフォントサイズが適用される
**検証対象: 要件 5.1**

**プロパティ16: 太字書式適用**
*任意の*Markdown太字記法（**text**、__text__）に対して、記法が除去されExcelの太字書式が適用される
**検証対象: 要件 5.2**

**プロパティ17: 斜体書式適用**
*任意の*Markdown斜体記法（*text*、_text_）に対して、記法が除去されExcelの斜体書式が適用される
**検証対象: 要件 5.3**

**プロパティ18: 取り消し線書式適用**
*任意の*Markdown取り消し線記法（~~text~~）に対して、記法が除去されExcelの取り消し線書式が適用される
**検証対象: 要件 5.4**

**プロパティ19: ハイパーリンク書式適用**
*任意の*Markdownリンク記法に対して、リンクテキストが抽出されExcelのハイパーリンク書式が適用される
**検証対象: 要件 5.5**

**プロパティ20: 画像要素書式適用**
*任意の*Markdown画像記法に対して、代替テキストが出力され背景色で画像要素が示される
**検証対象: 要件 5.6**

**プロパティ21: インラインコード書式適用**
*任意の*Markdownインラインコードに対して、バッククォートが除去され等幅フォントと背景色が適用される
**検証対象: 要件 5.7**

**プロパティ22: 引用書式適用**
*任意の*Markdown引用記法（> text）に対して、引用マーカーが除去されセルの左境界線と背景色が適用される
**検証対象: 要件 5.8**

**プロパティ23: 水平線書式適用**
*任意の*Markdown水平線記法（---、***、___）に対して、セル全体に下境界線が適用される
**検証対象: 要件 5.9**

**プロパティ24: 複合書式適用**
*任意の*複数の書式が組み合わされたMarkdownに対して、複数のExcel書式が同時に適用される
**検証対象: 要件 5.10**

## エラーハンドリング

### ファイル関連エラー
- **存在しないファイル**: 明確なエラーメッセージと終了コード1
- **読み込み権限なし**: 権限エラーメッセージと終了コード2
- **書き込み権限なし**: 出力先権限エラーメッセージと終了コード3
- **不正なファイル形式**: ファイル形式エラーメッセージと終了コード4

### 解析エラー
- **不正なMarkdown構文**: 警告メッセージを表示し、可能な限り処理を継続
- **エンコーディングエラー**: UTF-8での再試行、失敗時はエラーメッセージ

### Excel生成エラー
- **ディスク容量不足**: 容量不足エラーメッセージと終了コード5
- **ファイルロック**: ファイル使用中エラーメッセージと終了コード6

## テスト戦略

### 二重テストアプローチ

このプロジェクトでは、単体テストとプロパティベーステストの両方を実装します：

- **単体テスト**: 具体的な例、エッジケース、エラー条件を検証
- **プロパティベーステスト**: すべての入力に対して成り立つべき普遍的なプロパティを検証
- 両者は補完的であり、包括的なカバレッジを提供します：単体テストは具体的なバグを捕捉し、プロパティテストは一般的な正確性を検証します

### 単体テスト

単体テストは以下をカバーします：
- 具体的な動作例の実証
- コンポーネント間の統合ポイント
- 過度に多くの単体テストは避け、プロパティベーステストが多くの入力をカバーする役割を担います

### プロパティベーステスト

- **使用ライブラリ**: JavaScript用のfast-checkライブラリを使用
- **テストフレームワーク**: Jest または Vitest を使用
- **実行回数**: 各プロパティベーステストは最低100回の反復実行を設定
- **タグ付け**: 各プロパティベーステストには設計書の正確性プロパティを参照するコメントを付与
- **タグ形式**: '**Feature: markdown-to-excel, Property {番号}: {プロパティテキスト}**'
- **実装**: 各正確性プロパティは単一のプロパティベーステストで実装
- これらの要件をテスト戦略部分で明示的に記載

### 使用技術スタック

- **フレームワーク**: Electron（デスクトップアプリケーション）
- **言語**: TypeScript（型安全性とコード品質向上）
- **Markdown解析**: marked または markdown-it ライブラリ
- **Excel生成**: exceljs ライブラリ
- **テスト**: Jest + fast-check（プロパティベーステスト）
- **ビルド**: electron-builder（単一実行ファイル生成）
